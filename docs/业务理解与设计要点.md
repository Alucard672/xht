# Xianghuotong 业务理解与设计要点

Version: 1.0

开发背景与目标

- 面向农村市场的 B2B2C 乡镇批发 SaaS，连接商家端（批发部）与小卖部端（村镇客户），解决手写单据混乱、赊账难记、多单位换算复杂等痛点。
- 提供商品管理（多单位）、双端交易、自动记账、赊账管理等核心能力。

## 1. 业务角色与用户场景

- 商家端（商家/批发部老板）
  - 管理商品、分类、库存、订单、客户、店铺设置
  - 处理订单（接单、发货、完成）并管理赊账
- 客户端（小卖部/村镇商家）
  - 扫码进店、浏览商品、下单、查看欠款、还款
- 管理端（平台端）
  - 商户数据与系统数据的监管与统计

## 2. 领域模型与数据分层（Tenant 隔离）

- 多租户架构：每个商户为一个 Tenant，所有数据查询都需按 tenant_id 过滤。
- 关键数据表（核心字段）
  - wh_tenants: 租户信息与设置
  - wh_goods: 商品信息，支持多单位、库存以最小单位存储
  - wh_customers: 客户信息与欠款余额
  - wh_orders: 订单信息，包含商品快照、总金额、支付方式、状态
  - wh_debt_logs: 欠款流水，记录欠款增加/减少
- 访问控制：云对象（云函数/云对象）在 \_before 钩子中绑定 tenant_id，并在查询中强制筛选 tenant_id。

## 3. 多单位与库存/价格规则

- 多单位单位换算
  - rate 表示换算率，例如 rate=24 代表 1 大单位等于 24 个小单位
  - stock 字段以最小单位存储，例：240 代表 10 大单位（若 rate=24）
  - 显示库存：Math.floor(stock / rate) 大单位 + stock % rate 小单位
- 价格与金额的整数化
  - 数据库中价格以分为单位存储（整数）
  - 展示时除以 100 转换为元，避免浮点误差
- 订单金额计算
  - 购物车的总金额以最小单位计算，最终订单 total_fee 使用分单位保存

## 4. 赊账与还款机制

- 欠款字段
  - wh_customers.total_debt 为当前欠款总额，单位为分
  - wh_debt_logs 记录每笔欠款变动，type 字段区分订单欠款/还款/调整
- 还款流程
  - 还款通过事务扣减总欠款，并在 debt_logs 记录负数金额表示还款
- 订单完成时的赊账处理
  - 若订单 payment_method = credit，完成时将订单金额记入客户总欠款，并记录 debt_log

## 5. 业务流程概要

- 下单流程：客户下单 -> 商家接单 -> 发货 -> 完成 -> 赊账处理（如适用）
- 还款流程：客户在资产页提交还款 -> 系统扣减欠款 -> debt_logs 记录
- 扫码进店：客户端通过商家店铺码进入，自动绑定 tenant_id

## 6. 数据一致性与容错

- 采用事务处理涉及的金额变更与流水记录，确保原子性
- 前端展示与后端存储分离：金额以分存储，显示时按元展示

## 7. 接口与云对象概览

- 云对象 wh-goods-co、wh-orders-co、wh-customers-co、wh-merchant-co 等负责各自领域的 CRUD 与业务操作
- 所有操作都应通过云对象入口，确保 tenant_id 的一致性与权限控制

## 8. 设计假设与约束

- 离线场景下 UI 需要具备较高可用性（大按钮、对比度高的文本、简易语言）
- 初期以小规模商户为重点，逐步扩展并引入性能优化、数据分析看板等

## 9. 迭代与变更记录

- 本文档为当前设计的初步版本，后续如有流程变化、字段调整，将更新此文档并在版本控制中记录变更记录。

> 参考的核心 Schema/代码片段：
>
> - uniCloud-aliyun/database/wh_goods.schema.json
> - uniCloud-aliyun/database/wh_customers.schema.json
> - uniCloud-aliyun/database/wh_orders.schema.json
> - src/common/stock-helper.ts
> - src/common/price-helper.ts
> - src/composables/useGoods.ts
> - uniCloud-aliyun/cloudfunctions/wh-goods-co/index.obj.js
> - uniCloud-aliyun/cloudfunctions/wh-order-co/index.obj.js
> - uniCloud-aliyun/cloudfunctions/wh-customer-co/index.obj.js
