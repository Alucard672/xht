# 乡货通 (Xianghuotong) 产品需求文档

> **版本**: v1.1  
> **最后更新**: 2026-01-16

---

## 1. 目标用户

| 角色           | 英文     | 账号类型            | 付费模式        | 核心权限                                       |
| -------------- | -------- | ------------------- | --------------- | ---------------------------------------------- |
| **SaaS服务商** | Provider | 系统管理员          | -               | 全局配置、商家管理、有效期策略                 |
| **商家**       | Merchant | 商家账号 (uni-id)   | 有效期制 (付费) | 商品管理、客户管理、开单、订单处理、店铺二维码 |
| **客户**       | Customer | 客户账号 (微信授权) | 免费            | 浏览店铺、下单、查看订单和欠款                 |

### 角色边界说明

```
┌─────────────────────────────────────────────────────────────────┐
│                      SaaS 服务商 (Provider)                      │
│  • 配置有效期策略                                                │
│  • 创建/审核商家账号                                             │
│  • 全局数据统计                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│       商家 (Merchant)   │     │       客户 (Customer)    │
│  • 商家账号: uni-id     │     │  • 客户账号: 微信OpenID  │
│  • 付费使用             │     │  • 免费使用             │
│  • 有效期由服务商控制   │     │  • 永久有效             │
│                        │     │                         │
│  • 管理后台视角         │     │  • 店铺浏览视角         │
│  • 商品/客户/订单管理   │     │  • 浏览/下单/付款       │
│  • 直接开单             │     │                         │
│  • 生成店铺二维码       │     │                         │
└─────────────────────────┘     └─────────────────────────┘
```

---

## 2. 要解决的问题

### 2.1 核心痛点

| 痛点               | 解决方案                          |
| ------------------ | --------------------------------- |
| 手写单据、对账混乱 | 数字化订单与自动记账              |
| 赊账管理难以追踪   | 统一的欠款流水记录 (wh_debt_logs) |
| 多单位换算复杂     | 统一的换算率机制与最小单位存储    |
| 跨租户数据错配     | 强制 tenant_id 隔离               |
| 缺乏店铺入口       | 店铺二维码扫码进店                |

### 2.2 业务目标

- **效率提升**: 订单处理时间缩短 50%
- **准确性**: 金额、库存、单位换算 100% 准确
- **易用性**: 农村用户能独立完成下单与还款
- **资金安全**: 欠款流水可追溯，支持自动对账

---

## 3. 一句话描述产品

> 一个面向农村批发的 SaaS 平台，提供多单位商品管理、端到端下单-发货流程、以及智能赊账管控，确保租户数据隔离、金额精确存储、并简化前端用户体验。

---

## 4. 核心功能 (P0)

### 4.1 客户端 (C端) - 小卖部老板

| 功能                    | 优先级 | 状态      |
| ----------------------- | ------ | --------- |
| 扫码进店                | P0     | ✅ 已完成 |
| 商品列表 (含多单位展示) | P0     | ✅ 已完成 |
| 购物车 (多单位组合)     | P0     | ✅ 已完成 |
| 下单结算                | P0     | ✅ 已完成 |
| 订单列表                | P0     | ✅ 已完成 |
| 订单详情                | P0     | ✅ 已完成 |
| 我的资产 (欠款展示)     | P0     | ✅ 已完成 |
| 赊账申请                | P0     | ✅ 已完成 |
| 我的商家列表            | P0     | ⏳ 待开发 |
| 客户解绑商家            | P2     | ⏳ 待开发 |

### 4.2 商家端 (B端) - 批发部老板

| 功能                        | 优先级 | 状态      |
| --------------------------- | ------ | --------- |
| 商家登录                    | P0     | ✅ 已完成 |
| 商家入驻                    | P0     | ✅ 已完成 |
| 工作台 (数据概览)           | P0     | ✅ 已完成 |
| 商品管理 (增删改查)         | P0     | ✅ 已完成 |
| 分类管理                    | P0     | ✅ 已完成 |
| 订单列表                    | P0     | ✅ 已完成 |
| 订单详情                    | P0     | ✅ 已完成 |
| 订单处理 (接单->发货->完成) | P0     | ✅ 已完成 |
| **商家直接开单**            | P0     | ⏳ 待开发 |
| 客户管理                    | P0     | ✅ 已完成 |
| 手动记一笔                  | P0     | ✅ 已完成 |
| 还一笔 (还款录入)           | P0     | ✅ 已完成 |
| 店铺设置                    | P0     | ✅ 已完成 |
| 库存预警                    | P0     | ✅ 已完成 |
| 消息通知                    | P0     | ✅ 已完成 |
| **店铺二维码**              | P0     | ⏳ 待开发 |
| **商家有效期管理**          | P0     | ⏳ 待开发 |
| **商家审核**                | P1     | ⏳ 待开发 |
| **财务报表统计**            | P1     | ⏳ 待开发 |

### 4.3 管理端 (Admin)

| 功能              | 优先级 | 状态      |
| ----------------- | ------ | --------- |
| 商户管理列表      | P0     | ✅ 已完成 |
| **商家编辑/审核** | P0     | ⏳ 待开发 |
| 员工管理列表      | P0     | ✅ 已完成 |
| 数据统计页        | P0     | ✅ 已完成 |

---

## 5. 不做的功能 (当前版本)

| 功能             | 说明                         | 原因                             |
| ---------------- | ---------------------------- | -------------------------------- |
| 商家自购逻辑     | 商家在自己店铺下单的特殊处理 | 按普通客户订单处理，无需特殊逻辑 |
| 订单类型区分     | 区分代下单/自购等状态        | 无此业务需求，统一按普通订单处理 |
| 数据导出功能     | 订单/客户/商品导出 Excel     | 乡镇无深度数据分析需求           |
| 商家后台店铺入口 | 工作台增加"进入店铺"按钮     | 无此业务需求                     |
| 高级分析看板     | 预测性库存、复杂财务报表     | v2.0                             |
| 实时推送通知     | 离线策略的复杂实现           | v2.0                             |
| 跨租户数据汇总   | 全局数据对比与分析           | v2.0                             |
| 多币种支持       | 汇率换算                     | v2.0                             |
| 自动化对账       | 银行流水自动匹配             | v3.0                             |

---

## 6. 用户流程

### 6.1 客户端流程 (C端)

```
┌─────────────────────────────────────────────────────────────────────┐
│                         客户端用户流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. 扫码进店                                                        │
│     ├── 用户扫码 → 解析 tenant_id                                   │
│     ├── 自动创建/查询客户记录 (wh_customers)                        │
│     └── 跳转商品列表页                                               │
│                                                                     │
│  2. 浏览商品                                                        │
│     ├── 左侧分类导航                                                │
│     ├── 右侧商品流                                                  │
│     └── 多单位展示: 显示 "￥24/箱"                                  │
│                                                                     │
│  3. 加入购物车                                                      │
│     ├── 点击 "+" → 弹出选规格面板                                   │
│     ├── 支持复杂数量: [ 2 ] 箱 [ 5 ] 瓶                             │
│     └── 实时计算总价                                                │
│                                                                     │
│  4. 下单结算                                                        │
│     ├── 确认收货地址                                                │
│     ├── 选择支付方式 (默认 "记账/赊账")                             │
│     └── 创建订单 (wh_orders)                                        │
│                                                                     │
│  5. 订单处理                                                        │
│     ├── 商家接单 → 待发货                                           │
│     ├── 商家发货 → 已发货                                           │
│     └── 商家完成 → 订单完成                                         │
│                                                                     │
│  6. 赊账与还款                                                      │
│     ├── 订单完成且支付方式为 credit 时:                             │
│     │   └── total_debt += order_amount                              │
│     │   └── 记录 debt_logs (type: order)                            │
│     └── 客户还款:                                                   │
│         └── total_debt -= repay_amount                              │
│         └── 记录 debt_logs (type: repayment)                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 商家端流程 (B端)

```
┌─────────────────────────────────────────────────────────────────────┐
│                         商家端用户流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. 工作台                                                          │
│     ├── 今日数据: 订单数、销售额                                    │
│     └── 常用功能入口: 开单、商品、客户、店铺码                       │
│                                                                     │
│  2. 商品管理                                                        │
│     ├── 新增商品: 上传图片、设置多单位换算率                        │
│     └── 库存管理: 直接修改库存数字                                  │
│                                                                     │
│  3. 商家直接开单                                                    │
│     ├── 点击"开单"                                                 │
│     ├── 选择客户 (可为空，后续补全)                                 │
│     ├── 选择商品 (支持多单位)                                       │
│     ├── 确认订单信息                                                │
│     └── 创建订单                                                    │
│          └── 记录 created_by (商家 UID)                             │
│                                                                     │
│  4. 订单处理                                                        │
│     ├── 新订单通知                                                  │
│     ├── 接单 → 待发货                                               │
│     ├── 发货 → 已发货                                               │
│     └── 完成: 确认送达                                             │
│                                                                     │
│  5. 赊账管理 (核心)                                                 │
│     ├── 客户列表按欠款金额排序                                      │
│     ├── 记一笔: 手动录入欠款 (非订单)                               │
│     └── 还一笔: 录入还款金额，自动扣减欠款                          │
│                                                                     │
│  6. 店铺二维码                                                      │
│     ├── 生成店铺码                                                  │
│     └── 客户扫码进店                                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.3 订单创建说明

**下单人记录**:

- 客户下单: `created_by` = 客户 UID
- 商家开单: `created_by` = 商家 UID
- 统一按普通订单处理，无需区分代下单/自购状态

---

## 7. 业务规则

### 7.1 商家有效期管理

```
商家账号生命周期:
├── 创建方式: 服务商创建 OR 商家自主注册
├── 有效期: 由服务商统一配置 (如: 30天/90天/365天)
├── 付费: 需在有效期内付费续期
├── 过期: 账号冻结，店铺无法访问
└── 数据保留: 过期后数据保留N天(可配置)，过期后彻底删除
```

### 7.2 客户关联机制

```
客户首次扫码进入商家店铺:
├── 授权微信信息 → 创建客户账号 (uni-id-users)
├── 创建客户记录 → wh_customers 表 (商家视角)
└── 建立关联 → 记录到 wh_customer_tenants 表

客户后续访问:
├── 从"我的商家"列表进入
└── 或再次扫码进入
```

### 7.3 租户隔离规则

| 数据表         | 隔离方式 | 索引字段    | 说明                 |
| -------------- | -------- | ----------- | -------------------- |
| `wh_tenants`   | 全局     | -           | 商家信息全局可见     |
| `wh_goods`     | 租户隔离 | `tenant_id` | 仅商家可见自己的商品 |
| `wh_customers` | 租户隔离 | `tenant_id` | 商家视角的客户记录   |
| `wh_orders`    | 租户隔离 | `tenant_id` | 商家视角的订单记录   |
| `uni-id-users` | 全局     | -           | 所有用户共享         |
| `wh_debt_logs` | 租户隔离 | `tenant_id` | 赊账记录             |

### 7.4 多单位与价格规则

```
商品定义:
├── unit_small: { name: "瓶", price: 100 }  // 小单位配置
├── unit_big: { name: "箱", price: 2400 }   // 大单位配置
├── rate: 24  // 换算率: 1箱 = 24瓶
└── stock: 240  // 库存(以最小单位存储: 240瓶 = 10箱)

库存显示:
├── 大单位数量: Math.floor(240 / 24) = 10
├── 小单位数量: 240 % 24 = 0
└── 显示为: "10箱0瓶"

价格计算:
├── 用户选择: 2箱 + 5瓶
├── 转换为最小单位: 2*24 + 5 = 53瓶
└── 总价: 53 * 100 = 5300分 = 53元
```

### 7.5 金额规则

```
存储规则:
├── 所有金额以"分"为单位存储 (整数)
├── 禁止使用浮点数存储金额
└── 前端展示时除以100

示例:
├── 存入数据库: 10050
├── 前端展示: 100.50 元
└── 转换为分: toFen(100.50) = 10050
```

### 7.6 下单人记录规则

```
订单创建时记录 created_by:
├── 客户下单: created_by = 客户 UID
├── 商家开单: created_by = 商家 UID
└── 统一按普通订单处理，无需特殊状态区分
```

---

## 8. 数据库设计

### 8.1 租户表 (wh_tenants)

| 字段           | 类型      | 描述                                       |
| -------------- | --------- | ------------------------------------------ |
| `_id`          | String    | 租户唯一ID                                 |
| `name`         | String    | 店铺名称                                   |
| `owner_uid`    | String    | 关联的老板 uni-id                          |
| `owner_mobile` | String    | 老板手机号                                 |
| `status`       | Int       | 状态: 0-待审核, 1-正常, 2-已冻结, 3-已过期 |
| `expired_at`   | Timestamp | 会员到期时间                               |
| `settings`     | Object    | 店铺配置                                   |
| `created_at`   | Timestamp | 创建时间                                   |
| `updated_at`   | Timestamp | 更新时间                                   |

### 8.2 商品表 (wh_goods)

| 字段            | 类型    | 描述                        |
| --------------- | ------- | --------------------------- |
| `tenant_id`     | String  | **[索引]** 所属商家         |
| `name`          | String  | 商品名称                    |
| `category_id`   | String  | 分类ID                      |
| `img_url`       | String  | 图片地址                    |
| `is_multi_unit` | Boolean | 是否开启多单位              |
| `unit_big`      | Object  | 大单位配置 { name, price }  |
| `unit_small`    | Object  | 小单位配置 { name, price }  |
| `rate`          | Int     | 换算率 (1大单位 = N小单位)  |
| `stock`         | Int     | **总库存 (以最小单位存储)** |
| `is_on_sale`    | Boolean | 上架状态                    |

### 8.3 客户表 (wh_customers)

| 字段              | 类型      | 描述                    |
| ----------------- | --------- | ----------------------- |
| `tenant_id`       | String    | **[索引]** 所属商家     |
| `user_uid`        | String    | 关联的用户 UID          |
| `alias`           | String    | 商家备注名              |
| `phone`           | String    | 手机号                  |
| `total_debt`      | Int       | **当前欠款总额 (分)**   |
| `credit_limit`    | Int       | 赊账额度 (分)，默认5000 |
| `last_trade_time` | Timestamp | 最后交易时间            |
| `created_at`      | Timestamp | 首次关联时间            |

### 8.4 订单表 (wh_orders)

| 字段             | 类型      | 描述                                    |
| ---------------- | --------- | --------------------------------------- |
| `tenant_id`      | String    | **[索引]**                              |
| `customer_id`    | String    | 下单客户ID                              |
| `order_no`       | String    | 订单号                                  |
| `status`         | Int       | 0:待接单, 1:待发货, 2:已完成, -1:已取消 |
| `payment_method` | String    | `credit` (赊账), `wechat` (在线支付)    |
| `items`          | Array     | 商品快照数组                            |
| `total_fee`      | Int       | 订单总金额 (分)                         |
| `created_by`     | String    | **下单人 UID** (客户或商家)             |
| `created_at`     | Timestamp | 创建时间                                |

### 8.5 赊账记录表 (wh_debt_logs)

| 字段          | 类型      | 描述                          |
| ------------- | --------- | ----------------------------- |
| `tenant_id`   | String    | **[索引]** 所属商家           |
| `customer_id` | String    | 客户ID                        |
| `type`        | String    | `borrow`(赊账), `repay`(还款) |
| `amount`      | Int       | **金额 (分)**                 |
| `source`      | String    | `order`(订单), `manual`(手动) |
| `order_id`    | String    | 关联订单ID                    |
| `remark`      | String    | 备注                          |
| `created_at`  | Timestamp | 创建时间                      |

### 8.6 商家店铺二维码表 (wh_shop_codes) - 待创建

| 字段         | 类型      | 描述                      |
| ------------ | --------- | ------------------------- |
| `tenant_id`  | String    | **[索引]** 所属商家       |
| `code`       | String    | 店铺码 (Base64编码的JSON) |
| `qr_url`     | String    | 二维码图片地址            |
| `is_active`  | Boolean   | 是否有效                  |
| `scan_count` | Int       | 扫码次数                  |
| `created_at` | Timestamp | 创建时间                  |

### 8.7 客户关联商家表 (wh_customer_tenants) - 待创建

| 字段            | 类型      | 描述               |
| --------------- | --------- | ------------------ |
| `user_uid`      | String    | **[索引]** 客户UID |
| `tenant_id`     | String    | **[索引]** 商家ID  |
| `first_scan_at` | Timestamp | 首次扫码时间       |
| `last_visit_at` | Timestamp | 最近访问时间       |
| `total_orders`  | Int       | 累计订单数         |
| `total_spent`   | Int       | 累计消费 (分)      |
| `created_at`    | Timestamp | 关联创建时间       |

---

## 9. 待办任务清单

### 9.1 P0 - 核心架构完善

| ID      | 任务               | 描述                                            | 状态      |
| ------- | ------------------ | ----------------------------------------------- | --------- |
| IMP-001 | 商家开单记录下单人 | 订单记录 created_by，无需区分代下单/自购        | ⏳ 待开始 |
| IMP-002 | 商家有效期管理     | 完善商家审核、有效期校验、过期处理              | ⏳ 待开始 |
| IMP-003 | 客户关联表         | 创建 wh_customer_tenants 表，支持"我的商家"功能 | ⏳ 待开始 |
| IMP-004 | 商家店铺二维码     | 创建 wh_shop_codes 表，支持扫码进店             | ⏳ 待开始 |

### 9.2 P1 - 功能完善

| ID      | 任务         | 描述                             | 状态      |
| ------- | ------------ | -------------------------------- | --------- |
| IMP-005 | 商家注册流程 | 完善商家自主注册与审核流程       | ⏳ 待开始 |
| IMP-006 | 财务报表统计 | 按时间范围筛选统计，支持图表展示 | ⏳ 待开始 |

### 9.3 P2 - 体验优化

| ID      | 任务         | 描述                     | 状态      |
| ------- | ------------ | ------------------------ | --------- |
| IMP-007 | 扫码确认提示 | 进入店铺时显示提示       | ⏳ 待开始 |
| IMP-008 | 客户解绑商家 | 支持客户主动取消关联商家 | ⏳ 待开始 |

---

## 10. 验收标准

### 10.1 功能验收

- [ ] 所有 P0 功能按用户流程可正常运行
- [ ] 租户隔离: 所有数据查询强制 tenant_id 过滤
- [ ] 多单位换算正确: 库存、价格、购物车计算 100% 准确
- [ ] 欠款流水完整: debt_logs 记录每笔欠款变动
- [ ] 订单 created_by 正确记录下单人

### 10.2 数据验收

- [ ] 金额以分存储，前端展示除以 100
- [ ] 库存以最小单位存储，显示时拆分为大/小单位
- [ ] 订单状态流转符合流程定义

### 10.3 安全验收

- [ ] 无跨租户数据泄露
- [ ] 敏感字段最小暴露
- [ ] 审计日志存在

---

## 11. 后续迭代计划

### v1.1 (当前)

- [x] 核心功能完成 (25+ 页面)
- [ ] 核心架构完善 (IMP-001 ~ IMP-004)

### v1.2

- [ ] 商家注册流程 (IMP-005)
- [ ] 财务报表统计 (IMP-006)

### v2.0

- [ ] 高级分析看板
- [ ] 实时推送通知
- [ ] 跨租户数据汇总

---

## 12. 变更记录

| 日期       | 版本 | 变更内容                                                                                                   | 变更人  |
| ---------- | ---- | ---------------------------------------------------------------------------------------------------------- | ------- |
| 2026-01-16 | v1.0 | 初始版本                                                                                                   | AI 助手 |
| 2026-01-16 | v1.1 | 1. 删除代下单/自购逻辑，统一按普通订单处理 2. 删除数据导出功能 3. 删除商家后台店铺入口 4. 简化商家开单逻辑 | AI 助手 |

---

> **文档维护**: 本文档随项目迭代持续更新  
> **签字确认**: ****\_\_\_\_**** (产品) / ****\_\_\_\_**** (技术)
